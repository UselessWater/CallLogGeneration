# 项目地址：https://gitee.com/uselesswater/CallLogGeneration

# 通话记录生成工具 v2.1.0 更新说明

## 🎯 版本亮点
本次更新引入了**字段级智能降级机制**，彻底解决了多厂商设备兼容性问题，同时修复了关键bug并新增多项功能。

## ✨ 新增功能

### 1. 智能字段级降级系统
- **厂商兼容性增强**：支持vivo、Google SDK、标准Android设备
- **多字段优先级尝试**：对每个功能字段按优先级顺序尝试设置
- **优雅降级机制**：厂商特有字段失败时自动使用标准Android字段
- **详细日志记录**：完整记录字段设置过程和降级情况

### 2. 通话类型扩展
- **VoIP通话支持**：新增VoIP通话记录生成功能
- **网络类型选择**：支持2G/3G/4G/5G/WiFi网络类型设置
- **拒接来电修复**：正确生成拒接来电类型（CALL_TYPE_REJECTED = 5）

### 3. 高级设置面板
- **响铃时长调节**：为未接/拒接来电设置自定义响铃时长（1-60秒）
- **网络类型选择**：VoIP通话时选择网络技术类型
- **自定义时长范围**：精确控制通话时长范围
- **更新策略选择**：可选择"总是更新到最新版"或"只更新到新版本"

## 🐛 Bug修复

### 关键问题修复
- **拒接来电类型错误**：修复了拒接来电被错误生成为呼出电话的问题
- **时长逻辑修正**：拒接和未接来电的duration字段现在正确设置为0
- **SIM卡字段崩溃**：修复了厂商特有字段不存在导致的崩溃问题

### 兼容性改进
- **Google SDK设备支持**：完美适配gphone64_x86_64等标准Android设备
- **多厂商字段支持**：自动识别并适配不同厂商的通话记录字段结构
- **异常处理增强**：所有字段操作都有try-catch保护

## 🔧 技术改进

### 架构优化
- **模块化设计**：将通话记录生成逻辑分离到独立的`CallLogGenerator`类
- **常量集中管理**：所有硬编码值统一在`Constants.kt`中管理
- **通用降级方法**：实现可重用的`setFieldWithFallback`通用降级机制

### 字段级降级支持
支持的降级字段类型包括：
- **SIM卡标识字段**：`simid` → `PHONE_ACCOUNT_ID`
- **响铃时长字段**：`record_duration` → `ring_duration` → `duration`
- **拒接原因字段**：`missed_reason` → `reject_reason` → `reason`
- **网络类型字段**：`network_type` → `network` → `connection_type`
- **VoIP标识字段**：`is_voip` → `is_voip_call` → `call_technology`

## 📊 兼容性验证

### 已测试设备类型
- ✅ **vivo设备**：支持特有`simid`字段显示SIM卡标识
- ✅ **Google SDK设备**：gphone64_x86_64等标准Android设备
- ✅ **其他Android设备**：自动降级到标准字段实现

### 字段支持情况
根据Google SDK设备实际查询结果：
- `subscription_id`: ✅ 支持（数字和字符串值）
- `subscription_component_name`: ✅ 支持
- `missed_reason`: ✅ 支持（值为0）
- `simid`: ❌ 不存在（触发降级）
- 其他vivo特有字段: ❌ 不存在（触发降级）

## 🚀 使用说明

### 新功能使用方法
1. **选择通话类型**：在高级设置中选择VoIP通话或其他类型
2. **设置响铃时长**：为未接/拒接来电调节响铃时间
3. **选择网络类型**：VoIP通话时选择网络技术
4. **查看降级日志**：在Logcat中查看字段降级过程详情

### 开发者信息
降级机制日志标签：
- `CallLogGenerator`: 通用字段降级日志
- `SIMAdapter`: SIM卡字段降级日志
- `CallLogInsert`: 记录插入详情日志

## 📝 版本历史

### v2.0 (当前版本)
- 新增字段级智能降级机制
- 修复拒接来电类型错误
- 新增VoIP通话支持
- 增强多设备兼容性

### v1.x (之前版本)
- 基础通话记录生成功能
- SIM卡选择支持
- 时间范围设置
- 批量生成功能

## 🔒 注意事项

- 确保授予所有必要权限：读写通话记录、读取手机状态等
- 在不同设备上运行时，字段降级情况可能有所不同
- 建议在生成前使用调试功能查看现有通话记录的字段结构

