# 更新日志

## v3.0.0 (2024-08-28)

### 🔧 Vivo设备专项增强
- **新增Vivo呼出未接通支持**：引入`VIVO_OUTGOING_UNANSWERED`通话类型，专门处理Vivo设备的呼出未接通场景
- **设备检测优化**：改进`isVivoDevice()`函数，通过Build.BRAND检测Vivo设备
- **类型系统扩展**：在CallType枚举中新增`VIVO_OUTGOING_UNANSWERED`类型，完善类型安全
- **常量定义**：新增`CALL_TYPE_VIVO_OUTGOING_UNANSWERED = 2`常量，区别于标准呼出未接通类型

### 📱 SDK版本重大升级
- **targetSdk升级**：从24升级到34（Android 14），符合Google Play最新发布要求
- **minSdk调整**：从24调整到22（Android 5.1），扩大设备兼容范围
- **API兼容性修复**：解决SubscriptionManager等API在不同SDK版本下的兼容性问题
- **构建验证**：完整验证升级后的构建流程，确保所有功能正常

### ✅ 单元测试框架完善
- **测试用例扩展**：新增`testCreateCallByTypeVivoOutgoingUnanswered`测试，验证Vivo设备特定功能
- **测试逻辑优化**：更新现有测试用例，支持设备特定的条件断言
- **函数可见性调整**：将`isVivoDevice()`从private改为public，支持单元测试访问
- **测试通过验证**：所有15个单元测试全部通过，包括新增的Vivo设备测试

### 🛠️ 代码架构改进
- **CallType枚举扩展**：新增`VIVO_OUTGOING_UNANSWERED`类型，完善通话类型体系
- **CallTypeUIState更新**：在`getFinalDuration`函数中处理新的Vivo类型
- **CallLogGenerator增强**：在`createOutgoingUnanswered`和`createCallByType`中添加Vivo设备特殊逻辑
- **when表达式完善**：修复所有相关when表达式的穷尽性检查

### 🔧 兼容性提升
- **Vivo设备功能完整性**：彻底解决Vivo设备呼出未接通功能限制
- **设备检测准确性**：基于Build.BRAND的可靠设备识别机制
- **向后兼容**：保持对非Vivo设备的完整兼容性
- **Google Play合规**：满足最新的应用发布要求

### 📋 修复的问题
- **Vivo设备限制**：解决了Vivo设备无法正确处理呼出未接通的问题
- **SDK兼容性**：修复了低版本SDK下的API兼容性问题
- **单元测试错误**：解决了测试中的设备检测和类型断言问题
- **构建失败**：修复了SDK升级后的构建配置问题

## v3.0.0 (2025-08-28)

### 重大架构升级
- **完全重写字段验证机制**：采用四级安全验证策略，彻底解决数据库约束冲突问题
- **非侵入式字段检测**：优先使用现有记录分析，避免创建测试记录导致的约束冲突
- **智能字段类型适配**：支持Int、Long、String等多种字段类型，确保正确设置字段值
- **代码架构重构**：引入CallType枚举、CallTypeUIState数据类、ValidationResult密封类
- **类型安全增强**：实现防御性编程、集中状态管理、改进的错误处理机制

### 核心改进
- **四级验证策略**：
  1. 非侵入式查询验证 - 通过现有记录验证字段可查询性
  2. 数据库schema检查 - 确认字段在数据库中存在
  3. 现有记录使用分析 - 检查字段在实际记录中的使用情况
  4. 安全测试验证 - 作为最后手段的最小化测试
- **多类型字段支持**：完整支持Int、Long、String、Boolean等所有ContentValues支持的数据类型
- **约束感知验证**：在验证字段时复制现有记录的所有字段值，确保满足数据库约束条件
- **增强的清理机制**：模式匹配清理所有测试记录，防止测试记录残留

### 修复的关键问题
- **数据库约束冲突**：解决了NOT NULL约束、外键约束等导致的字段验证失败问题
- **字段类型不匹配**：修复了假设所有字段都是Int类型导致的类型转换错误
- **验证顺序逻辑**：优化验证流程，优先使用最安全的非侵入式方法
- **ContentValues类型安全**：正确处理Any类型到具体类型的转换，避免编译错误
- **单元测试框架问题**：修复AndroidJUnit4使用错误，解决常量冲突，完善测试环境配置

### 单元测试框架重构
- **移除不当依赖**：将`@RunWith(AndroidJUnit4::class)`改为标准JUnit4，避免仪器测试运行器错误
- **引入Robolectric**：添加`org.robolectric:robolectric:4.10.3`依赖，提供Android框架模拟
- **测试环境配置**：在`app/build.gradle.kts`中添加`testOptions { unitTests.isReturnDefaultValues = true }`
- **修复常量冲突**：解决`Constants.kt`中`CALL_TYPE_OUTGOING_UNANSWERED`和`CALL_TYPE_INCOMING`都为1的冲突
- **更新测试配置**：使用`@RunWith(RobolectricTestRunner::class)`和`@Config(sdk = [24])`
- **测试结果验证**：13个单元测试全部通过，覆盖所有通话类型和边界情况

### 技术特性
- **缓存优化**：30分钟字段检测缓存，减少重复检测开销
- **详细日志**：完整的字段验证过程日志，便于调试和分析
- **异常处理**：完善的异常捕获和处理机制，确保应用稳定性
- **资源管理**：正确的Cursor和ContentResolver资源释放
- **单元测试完善**：修复测试框架问题，引入Robolectric支持，13个单元测试全部通过

### 兼容性提升
- **厂商设备全覆盖**：支持vivo、小米、华为、OPPO、三星、荣耀等所有主流Android设备
- **Android版本兼容**：支持Android 7.0 (API 24) 到 Android 15 (API 36)
- **字段级降级**：智能识别设备支持的字段，自动降级到兼容实现
- **扩大设备支持范围**：新增Android 7.0兼容性，支持2016年及以后的Android设备

### 厂商设备兼容性详情
- **vivo设备**：支持基础功能，包括特有的`simid`字段显示SIM卡标识
  - ⚠️ **重要限制**：不支持呼出未接通功能，使用该功能会被识别为拒接来电
- **小米设备**：**完整支持所有功能**，包括呼出未接通，是兼容性最佳的设备
- **三星设备**：支持基础功能，标准Android字段实现
  - ⚠️ **已知问题**：响铃时间数据库字段被官方隐藏，生成的响铃时间始终显示为0
- **华为/荣耀设备**：支持基础功能，部分高级字段通过降级机制实现
- **OPPO设备**：支持基础功能，自动适配可用字段
- **其他Android设备**：通过字段级降级机制确保基础功能可用

## v2.2.6 (2025-08-25)

### 修复
- 修复了`setFieldWithFallback`方法中字段支持检查的重复处理问题
- 统一使用`DeviceFieldConfig.isFieldSupported`方法进行字段支持检查
- 消除了字段支持检查逻辑的不一致性

## v2.2.5 (2025-08-25)

### 修复
- 修复了`setFieldWithFallback`方法中对`MISSED_REASON_FIELD`类型字段处理不完整的问题
- 补充了对拒接原因字段的完整支持逻辑

## v2.2.4 (2025-08-25)

### 修复
- 修复了字段降级逻辑中的关键错误
- 修正了`setFieldWithFallback`方法中的降级字段判断逻辑
- 完善了字段类型系统，增加了`MISSED_REASON_FIELD`类型
- 优化了设备字段配置验证逻辑

## v2.2.3 (2025-08-25)

### 重大改进
- 实现了基于厂商和机型的静态字段配置机制
- 采用预定义各厂商机型字段配置的方式，确保最大兼容性
- 移除了不准确的运行时字段探测机制
- 通过设备配置验证确保字段使用准确性

### 修复
- 彻底解决了各厂商设备通话记录字段兼容性问题
- 确保不会在某个机型上使用到另外一个机型的字段
- 优化了SIM卡字段和响铃时长字段的厂商适配逻辑

## v2.2.2 (2025-08-25)

### 修复
- 修复了 `menuAnchor()` 方法的弃用警告，使用新的 `menuAnchor(MenuAnchorType.PrimaryNotEditable, true)` 语法
- 修复了 `versionCode` 字段的弃用警告，使用新的 `longVersionCode` API 并添加了向后兼容性处理
- 修复了版本号解析中的 `coerceAtMost` 函数使用问题，改用 `take` 函数
- 优化了版本号解析逻辑，更好地处理复杂的版本号格式，包括对 alpha、beta、rc 等预发布版本的支持
- 改进了更新检查逻辑，在版本比较失败时默认提示更新
- 增强了 APK 下载和安装过程中的资源管理，确保网络连接和文件流正确关闭
- 增大了下载缓冲区大小以提高下载速度
- 添加了更完善的异常处理和日志记录

### 兼容性改进
- 增强了对不同厂商设备的兼容性支持，包括 OPPO、荣耀、小米、三星等
- 扩展了厂商特定字段的支持，增加了更多设备适配字段
- 优化了字段级降级机制，提高在不同设备上的稳定性

## v2.1.0 (2025-08-23)

### 新特性
- 全新的现代化 Material Design 3 界面
- 改进了通话类型支持，增加了拒接来电类型
- 增强了响铃时长设置功能，支持未接来电和拒接来电的响铃时长自定义
- 添加了高级设置面板，提供更多自定义选项
- 实现了智能 SIM 卡适配方案，支持 vivo、小米、OPPO、三星、荣耀等厂商设备
- 采用字段级降级机制，确保在各种 Android 设备上的兼容性

### 技术改进
- 使用 Jetpack Compose 重构 UI 界面
- 更新到最新的 Kotlin 和 Compose 版本
- 改进了权限管理流程
- 优化了时间处理逻辑，使用 ThreeTenABP 库提供更好的日期时间支持
- 增强了错误处理和日志记录
- 实现了更智能的更新检查机制

## v1.0.0 (2024-05-20)

### 初始版本
- 基础通话记录生成功能
- 支持批量生成通话记录
- 多 SIM 卡支持
- 自定义时间设置
- Material Design 界面